<!doctype html>

<html lang="en-us">

<head>
  <title>Catousify</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="kiror0" /><meta name="generator" content="Hugo 0.62.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" />
  <script src="https://kit.fontawesome.com/b76b73e8e8.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="http://zeroload.github.io/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="http://zeroload.github.io/">Catousify</a>
            </h1>

      <ul id="social-media">
        
        
          
        <li><a href="https://github.com/kiror0"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
           
      </ul>
      
      <p><em>No Clever Tagline Needed.</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="http://zeroload.github.io/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://zeroload.github.io/about/">
                <i class="fa-li fa  fa-lg"></i><span>About Me</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>SharifCTF 2018 - fHash Writeup</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-02-04T16:16:15Z">Feb 4, 2018</time>
        </li>
        
        <li>
            Categories:
            <em>
                
                    
                    <a href="http://zeroload.github.io/categories/crypto">crypto</a>
                
                    , 
                    <a href="http://zeroload.github.io/categories/writeup">writeup</a>
                
            </em>
        </li>
        

        

        <li>3 minutes read</li>
    </ul>
</aside>

    

    <blockquote>
<p>fHash.py (<a href="https://pastebin.com/tEw7BPtX">https://pastebin.com/tEw7BPtX</a>)</p>
</blockquote>
<p><img src="https://a.safe.moe/MceKg" alt=""> Given a custom hash, the task is to create some kind of collision in order to get the flag. At this moment, I don't know what's this second-preimage thing, but the task is clear enough somehow we should get the collision with restriction <code>hl1 != hl2</code> and <code>hr1 != hr2</code> and <code>M1 != M2</code>. <code>hl</code> and <code>hr</code> <strong>must</strong> be 2 bytes and <code>M</code> <strong>must</strong> be 4 bytes. First, analyze the algorithm used.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#f92672">from</span> hashlib <span style="color:#f92672">import</span> md5

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(h, m):
    <span style="color:#66d9ef">return</span> md5(h<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">utf-8</span><span style="color:#e6db74">&#39;</span>) <span style="color:#f92672">+</span> m<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">utf-8</span><span style="color:#e6db74">&#39;</span>))<span style="color:#f92672">.</span>hexdigest()[:<span style="color:#ae81ff">4</span>]

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">round</span>(hl, m, hr):
    <span style="color:#66d9ef">return</span> foo(hl, m), foo(hr, m)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">fHash</span>(hl, hr, M):
    message <span style="color:#f92672">=</span> list(map(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">&#39;</span><span style="color:#f92672">.</span>join, zip(<span style="color:#f92672">*</span>[iter(M)] <span style="color:#f92672">*</span> <span style="color:#ae81ff">4</span>)))
    <span style="color:#66d9ef">for</span> m <span style="color:#f92672">in</span> message:
        hl, hr <span style="color:#f92672">=</span> round(hl, m, hr)
    <span style="color:#66d9ef">return</span> (hl, hr)

<span style="color:#66d9ef">if</span> __name__ <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">__main__</span><span style="color:#e6db74">&#39;</span>:
    <span style="color:#66d9ef">print</span>(fHash(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7575</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">A8A8</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7368617269666374</span><span style="color:#e6db74">&#39;</span>))
</code></pre></div><p><code>M</code> length must be the power of 4 so that it can be sliced into parts by 2 bytes. As for example <code>7368617269666374</code> =&gt; <code>7368</code>,<code>6172</code>,<code>6966</code>, and <code>6374</code>. After that, sliced <code>M</code> get to concatenated with <code>hl</code> or <code>hr</code> then the first 2 bytes of md5sum from the concatenated string will be used for next round <code>hl</code> or <code>hr</code>, repeated until last sliced part of <code>M</code>. For example, <code>7575</code> and <code>7368</code> =&gt; <code>md5sum(75757368)[:4]</code> =&gt; <code>dcd0</code> =&gt; <code>dcd0</code> and <code>6172</code> =&gt; <code>md5sum(dcd06172)[:4]</code> =&gt; and so on.. In diagram <img src="https://a.safe.moe/gVUMe.png" alt=""> Attack. Yes, Attacc boi. The flaw is in <code>foo(h, m)</code> where the return only the first 2 bytes of <code>md5sum(h + m)</code>. At first, my approach was to get all the bytes from <code>hl</code>, <code>hr</code>, and <code>M</code> to be different. That's where the exhausting part, until I just realized, <strong>all of the bytes doesn't needs to be different</strong> :|. Side story aside, the idea for this is to change the bytes used first round and the return for foo must be same as use in <code>hl1</code>, <code>hr1</code>, and <code>M1</code>. I did this with a crude bruteforce way,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#f92672">from</span> hashlib <span style="color:#f92672">import</span> md5
<span style="color:#f92672">import</span> sys

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">foo</span>(h, m):
    <span style="color:#66d9ef">return</span> md5(h<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">utf-8</span><span style="color:#e6db74">&#39;</span>) <span style="color:#f92672">+</span> m<span style="color:#f92672">.</span>encode(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">utf-8</span><span style="color:#e6db74">&#39;</span>))<span style="color:#f92672">.</span>hexdigest()[:<span style="color:#ae81ff">4</span>]

alpha <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">0123456789ABCDEF</span><span style="color:#e6db74">&#39;</span>
<span style="color:#75715e"># alpha = &#39;0123456789abcdef&#39;</span>

<span style="color:#66d9ef">for</span> hex1 <span style="color:#f92672">in</span> alpha:
    <span style="color:#66d9ef">for</span> hex2 <span style="color:#f92672">in</span> alpha:
        <span style="color:#66d9ef">for</span> hex3 <span style="color:#f92672">in</span> alpha:
            <span style="color:#66d9ef">for</span> hex4 <span style="color:#f92672">in</span> alpha:
                <span style="color:#66d9ef">for</span> hex5 <span style="color:#f92672">in</span> alpha:
                    <span style="color:#66d9ef">for</span> hex6 <span style="color:#f92672">in</span> alpha:
                        <span style="color:#66d9ef">for</span> hex7 <span style="color:#f92672">in</span> alpha:
                            <span style="color:#66d9ef">for</span> hex8 <span style="color:#f92672">in</span> alpha:
                                m <span style="color:#f92672">=</span>  hex1 <span style="color:#f92672">+</span> hex2 <span style="color:#f92672">+</span> hex3 <span style="color:#f92672">+</span> hex4
                                hl <span style="color:#f92672">=</span> hex5 <span style="color:#f92672">+</span> hex6 <span style="color:#f92672">+</span> hex7 <span style="color:#f92672">+</span> hex8
                                <span style="color:#66d9ef">if</span> foo(hl, m) <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">dcd0</span><span style="color:#e6db74">&#39;</span>:
                                    <span style="color:#66d9ef">for</span> hex9 <span style="color:#f92672">in</span> alpha:
                                        <span style="color:#66d9ef">for</span> hex10 <span style="color:#f92672">in</span> alpha:
                                            <span style="color:#66d9ef">for</span> hex11 <span style="color:#f92672">in</span> alpha:
                                                <span style="color:#66d9ef">for</span> hex12 <span style="color:#f92672">in</span> alpha:
                                                    hr <span style="color:#f92672">=</span> hex9 <span style="color:#f92672">+</span> hex10 <span style="color:#f92672">+</span> hex11 <span style="color:#f92672">+</span> hex12
                                                    <span style="color:#66d9ef">if</span> foo(hr, m) <span style="color:#f92672">==</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">a6ea</span><span style="color:#e6db74">&#39;</span>:
                                                        <span style="color:#66d9ef">print</span> hl, m, hr
                                                        sys<span style="color:#f92672">.</span>exit(<span style="color:#ae81ff">0</span>)
</code></pre></div><p>I put break at the end just to output one result, in fact there are dozens of result if this didn't stopped. It doesn't need to take long to run this bruteforce script, the output,</p>
<pre><code>45ED 0007 E19F
</code></pre><p>In diagram, <img src="https://a.safe.moe/N08T6.png" alt="">
The final answer, <code>hl2 = 45ED</code>, <code>hr2 = E19F</code>, <code>M2 = 0007617269666374</code>.
<img src="https://a.safe.moe/qBlm0.png" alt=""></p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://zeroload.github.io/posts/inctf-2017-secure-auth-writeup/"><i class="fa fa-chevron-circle-left"></i> INCTF 2017 - Secure Auth Writeup</a>
        </li>
        
        
        <li>
            <a href="http://zeroload.github.io/posts/simple-vm-joints-2018-writeup/">JOINTS 2018 - Simple VM WriteUp <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    





</main>
    <footer>
        <h6>Copyright © 2019 - kiror0 |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="http://zeroload.github.io/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="http://zeroload.github.io/js/scripts.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146594173-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
