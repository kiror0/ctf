<!doctype html>

<html lang="en-us">

<head>
  <title>Catousify</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="kiror0" /><meta name="generator" content="Hugo 0.62.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" />
  <script src="https://kit.fontawesome.com/b76b73e8e8.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="https://kiror0.github.io/ctf/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="https://kiror0.github.io/ctf/">Catousify</a>
            </h1>

      <ul id="social-media">
        
        
          
        <li><a href="https://github.com/kiror0"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
           
      </ul>
      
      <p><em>No Clever Tagline Needed.</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="https://kiror0.github.io/ctf/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="https://kiror0.github.io/ctf/about/">
                <i class="fa-li fa  fa-lg"></i><span>About Me</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>Bypassing Kakao Login Signature Check for Tampered Android Application</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2017-11-23T11:48:14Z">Nov 23, 2017</time>
        </li>
        
        <li>
            Categories:
            <em>
                
                    
                    <a href="https://kiror0.github.io/ctf/categories/trick">trick</a>
                
            </em>
        </li>
        

        

        <li>2 minutes read</li>
    </ul>
</aside>

    

    <p>I was experiencing something like can't login with Kakao when the app has been tampered. After going some trials and errors, I've found out that it requires Signature hash check for Login in. In <code>com.kakao.util.helper.Utility</code></p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String <span style="color:#a6e22e">getKeyHash</span><span style="color:#f92672">(</span>Context context<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
    String str <span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">;</span>
    PackageInfo packageInfo <span style="color:#f92672">=</span> getPackageInfo<span style="color:#f92672">(</span>context<span style="color:#f92672">,</span> 64<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">if</span> <span style="color:#f92672">(</span>packageInfo <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">null</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        Signature<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">[</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">]</span> signatureArr <span style="color:#f92672">=</span> packageInfo<span style="color:#f92672">.</span><span style="color:#a6e22e">signatures</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> length <span style="color:#f92672">=</span> signatureArr<span style="color:#f92672">.</span><span style="color:#a6e22e">length</span><span style="color:#f92672">;</span>
        <span style="color:#66d9ef">int</span> i <span style="color:#f92672">=</span> 0<span style="color:#f92672">;</span>
        <span style="color:#66d9ef">while</span> <span style="color:#f92672">(</span>i <span style="color:#f92672">&lt;</span> length<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
            Signature signature <span style="color:#f92672">=</span> signatureArr<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">[</span>i<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">]</span><span style="color:#f92672">;</span>
            <span style="color:#66d9ef">try</span> <span style="color:#f92672">{</span>
                MessageDigest md <span style="color:#f92672">=</span> MessageDigest<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SHA&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">byte</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">[</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">]</span> toByteArray <span style="color:#f92672">=</span> signature<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                md<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>signature<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                str <span style="color:#f92672">=</span> Base64<span style="color:#f92672">.</span><span style="color:#a6e22e">encodeToString</span><span style="color:#f92672">(</span>md<span style="color:#f92672">.</span><span style="color:#a6e22e">digest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span> 2<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">break</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span> <span style="color:#66d9ef">catch</span> <span style="color:#f92672">(</span>NoSuchAlgorithmException e<span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
                Log<span style="color:#f92672">.</span><span style="color:#a6e22e">w</span><span style="color:#f92672">(</span>TAG<span style="color:#f92672">,</span> <span style="color:#e6db74">&#34;Unable to get MessageDigest. signature=&#34;</span> <span style="color:#f92672">+</span> signature<span style="color:#f92672">,</span> e<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                i<span style="color:#f92672">+</span><span style="color:#f92672">+</span><span style="color:#f92672">;</span>
            <span style="color:#f92672">}</span>
        <span style="color:#f92672">}</span>
    <span style="color:#f92672">}</span>
    <span style="color:#66d9ef">return</span> str<span style="color:#f92672">;</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>This function returns the application signature SHA1 hash encoded in base64. Sure enough I just need replace <code>str</code> with original application signature to prevent apps using my crafted signature but thats <em><strong>too plain.</strong></em> I want a library that can be used again in the future if need it. So, my approach was using this another handcrafted class to return Signature.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java"><span style="color:#f92672">import</span> android.content.pm.Signature<span style="color:#f92672">;</span>
<span style="color:#f92672">import</span> java.math.BigInteger<span style="color:#f92672">;</span>

<span style="color:#66d9ef">public</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">xSign</span> <span style="color:#f92672">{</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> String bits <span style="color:#f92672">=</span> <span style="color:#e6db74">&#34;3082037130820259a003...............&#34;</span><span style="color:#f92672">;</span>
    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">byte</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">[</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">]</span> <span style="color:#66d9ef">byte</span> <span style="color:#f92672">=</span> <span style="color:#66d9ef">new</span> BigInteger<span style="color:#f92672">(</span>bits<span style="color:#f92672">,</span> 16<span style="color:#f92672">)</span><span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>

    <span style="color:#66d9ef">public</span> <span style="color:#66d9ef">static</span> Signature<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">[</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">]</span> arraySig<span style="color:#f92672">(</span><span style="color:#f92672">)</span> <span style="color:#f92672">{</span>
        <span style="color:#66d9ef">return</span> <span style="color:#66d9ef">new</span> Signature<span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">[</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">]</span> <span style="color:#f92672">{</span> <span style="color:#66d9ef">new</span> Signature<span style="color:#f92672">(</span>bits<span style="color:#f92672">)</span> <span style="color:#f92672">}</span><span style="color:#f92672">;</span>
    <span style="color:#f92672">}</span>
<span style="color:#f92672">}</span>
</code></pre></div><p>This looks a bit nasty, but it works. How this code should be used? copy Actual application signature hex encoded into <code>Signature bits</code>. As a /skid/ that needz toolz, use lohan+ tool for extracting signature from APK, from there you could get the APK signature bits too. (<a href="http://androidcracking.blogspot.com/2010/12/getting-apk-signature-outside-of.html">http://androidcracking.blogspot.com/2010/12/getting-apk-signature-outside-of.html</a>) Then, do change code into something looks like this.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-java" data-lang="java">                MessageDigest md <span style="color:#f92672">=</span> MessageDigest<span style="color:#f92672">.</span><span style="color:#a6e22e">getInstance</span><span style="color:#f92672">(</span><span style="color:#e6db74">&#34;SHA&#34;</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                <span style="color:#66d9ef">byte</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">[</span><span style="color:#960050;background-color:#1e0010">\</span><span style="color:#f92672">]</span> toByteArray <span style="color:#f92672">=</span> signature<span style="color:#f92672">.</span><span style="color:#a6e22e">toByteArray</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                md<span style="color:#f92672">.</span><span style="color:#a6e22e">update</span><span style="color:#f92672">(</span>xSign<span style="color:#f92672">.</span><span style="color:#a6e22e">byte</span><span style="color:#f92672">)</span><span style="color:#f92672">;</span>
                str <span style="color:#f92672">=</span> Base64<span style="color:#f92672">.</span><span style="color:#a6e22e">encodeToString</span><span style="color:#f92672">(</span>md<span style="color:#f92672">.</span><span style="color:#a6e22e">digest</span><span style="color:#f92672">(</span><span style="color:#f92672">)</span><span style="color:#f92672">,</span> 2<span style="color:#f92672">)</span><span style="color:#f92672">;</span>
</code></pre></div><p>All is set, recompile the code, run application, then profit. I could login with Kakao in a modified application. What have I learned from this? Signature checking isn't really proof from a <em>skid</em> to reverse engineer application. This code might come in handy if someone really need to <em>spoof</em> the Application signature.</p>


</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="https://kiror0.github.io/ctf/posts/the-revival/"><i class="fa fa-chevron-circle-left"></i> The Revival</a>
        </li>
        
        
        <li>
            <a href="https://kiror0.github.io/ctf/posts/agrihack-0x2-lift-rektorat-writeup/">AgriHack 0x2 - Lift Rektorat Writeup <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    





</main>
    <footer>
        <h6>Copyright Â© 2019 - kiror0 |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="https://kiror0.github.io/ctf/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="https://kiror0.github.io/ctf/js/scripts.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146594173-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
